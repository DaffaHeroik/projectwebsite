<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Payment Gateway</title>
<style>
    body { font-family: Arial; padding: 20px; background: #f5f5f5; }
    .card {
        background: white; padding: 20px; max-width: 450px;
        margin: auto; border-radius: 10px; box-shadow: 0 0 10px #ddd;
    }
    img { width: 100%; border-radius: 10px; }
    .center { text-align: center; }
</style>
</head>
<body>

<div class="card">
    <h2 class="center">Pembayaran Produk</h2>

    <div id="productBox">
        <p>Nama Produk: <b id="pName"></b></p>
        <p>Kategori: <b id="pCategory"></b></p>
        <p>Harga Asli: <b id="pPrice"></b></p>
    </div>

    <hr>

    <div id="paymentBox" style="display:none;">
        <h3 class="center">Scan QR Pembayaran</h3>
        <img id="qrImg" src="">
        <p class="center">Total Transfer: <b id="payAmount"></b></p>
        <p class="center">Expired: <b id="timer"></b></p>
        <p class="center" id="status">
            Status: <b style="color:red;">Menunggu Pembayaran...</b>
        </p>
    </div>
</div>

<script>
let idTransaksi = null;
let expectedAmount = null;
let expiredTime = null;
let checkInterval = null;

const BACKEND = "http://127.0.0.1:3000"; // contoh: "http://127.0.0.1:3000"
const urlParams = new URLSearchParams(window.location.search);
function getParams() {
    const url = new URL(window.location.href);
    return {
        id: url.searchParams.get("id"),
        name: url.searchParams.get("name"),
        price: Number(url.searchParams.get("price")),
        category: url.searchParams.get("category")
    };
}

async function startPayment() {
    const p = getParams();

    // tampilkan product info
    document.getElementById("pName").innerText = p.name;
    document.getElementById("pCategory").innerText = p.category;
    document.getElementById("pPrice").innerText = p.price.toLocaleString("id-ID");

    // == Request QR ke backend ==
    console.log("Mengirim request createqr...");
    const res = await fetch(`${BACKEND}/api/createqr`, {
        method: "POST",
        body: JSON.stringify({ amount: p.price }),
        headers: { "Content-Type": "application/json" }
    });

    const data = await res.json();

    if (!data.success) {
        alert("Gagal membuat pembayaran.");
        return;
    }

    idTransaksi = data.data.idTransaksi;
    expectedAmount = data.data.amount;
    expiredTime = new Date(data.data.expired);

    document.getElementById("qrImg").src = data.data.qrUrl;
    document.getElementById("payAmount").innerText = expectedAmount.toLocaleString("id-ID");

    document.getElementById("paymentBox").style.display = "block";

    startTimer();
    startChecking(p);
}

function startTimer() {
    const intv = setInterval(() => {
        const now = new Date();
        const diff = expiredTime - now;

        if (diff <= 0) {
            document.getElementById("timer").innerText = "Expired";
            clearInterval(intv);
            clearInterval(checkInterval);
            return;
        }

        const m = Math.floor(diff / 60000);
        const s = Math.floor((diff % 60000) / 1000);

        document.getElementById("timer").innerText = `${m}m ${s}s`;
    }, 1000);
}

function startChecking(productData) {
    checkInterval = setInterval(async () => {

        const res = await fetch(`${BACKEND}/api/checkpay`, {
            method: "POST",
            body: JSON.stringify({ amount: expectedAmount }),
            headers: { "Content-Type": "application/json" }
        });

        const data = await res.json();
console.log("Hasil createqr:", data);
        if (data.status === "paid") {
            document.getElementById("status").innerHTML =
                `<b style="color:green;">Pembayaran Berhasil!</b>`;

            clearInterval(checkInterval);

            // == REQUEST PEMBELIAN ==
            await fetch(`${BACKEND}/api/purchase`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    idTransaksi,
                    amount: expectedAmount,
                    productId: productData.id,
                    productName: productData.name,
                    category: productData.category
                })
            });

        }

    }, 10000); // cek 10 detik sekali
}

window.onload = startPayment;
</script>

</body>
</html>
